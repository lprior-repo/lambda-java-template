name: 🧹 Cleanup Ephemeral Infrastructure

on:
  pull_request:
    types: [closed]

concurrency:
  group: cleanup-${{ github.head_ref }}
  cancel-in-progress: false

env:
  TERRAFORM_VERSION: '1.9.8'

jobs:
  cleanup-ephemeral:
    name: 🧹 Destroy Ephemeral Infrastructure
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: 🏗️ Setup Terraform
        uses: hashicorp/setup-terraform@651471c36a6092792c552e8b1bef71e592b462d8 # v3.1.1
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: 🔧 Terraform Init
        working-directory: terraform
        run: terraform init

      - name: 🧹 Destroy Ephemeral Environment
        working-directory: terraform
        run: |
          # Generate unique namespace from PR number
          NAMESPACE="pr-${{ github.event.pull_request.number }}"
          PROJECT_NAME="lambda-java-template"
          
          echo "Destroying ephemeral environment: ${PROJECT_NAME}-${NAMESPACE}"
          
          terraform destroy -auto-approve \
            -var="project_name=${PROJECT_NAME}" \
            -var="aws_region=us-east-1" \
            -var="is_ephemeral=true" \
            -var="namespace=${NAMESPACE}"
        env:
          AWS_DEFAULT_REGION: us-east-1

      - name: 📝 Cleanup Summary
        run: |
          echo "## 🧹 Ephemeral Infrastructure Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully destroyed ephemeral environment for PR #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resources cleaned up:**" >> $GITHUB_STEP_SUMMARY
          echo "- Lambda functions: lambda-java-template-pr-${{ github.event.pull_request.number }}-*" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: lambda-java-template-pr-${{ github.event.pull_request.number }}-api" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB tables: lambda-java-template-pr-${{ github.event.pull_request.number }}-*" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch logs: /aws/lambda/lambda-java-template-pr-${{ github.event.pull_request.number }}-*" >> $GITHUB_STEP_SUMMARY