version: '3'

# AWS Lambda Java Template - Extreme DRY Taskfile
# Uses AWS Lambda containers for consistent native builds

vars:
  PROJECT_NAME: lambda-java-template
  AWS_REGION: us-east-1
  GRAALVM_VERSION: 21.0.2-graalce
  LAMBDA_CONTAINER: public.ecr.aws/lambda/provided:al2
  BUILD_DIR: ./build

tasks:
  default:
    desc: ğŸš€ Show available tasks
    cmds:
      - task --list

  # ğŸ§¹ Cleanup
  clean:
    desc: ğŸ§¹ Clean all build artifacts
    cmds:
      - rm -rf {{.BUILD_DIR}}
      - mvn clean -q

  # ğŸ—ï¸ Native Build (Docker Container - Like CI)
  native:
    desc: âš¡ Build GraalVM native executables using AWS Lambda container
    deps: [clean]
    cmds:
      - echo "ğŸš€ Building native executables in AWS Lambda container..."
      - docker pull {{.LAMBDA_CONTAINER}}
      - |
        docker run --rm \
          --entrypoint="" \
          -u "$(id -u):$(id -g)" \
          -v "$(pwd)":/workspace \
          -w /workspace \
          {{.LAMBDA_CONTAINER}} \
          bash -c "
            yum update -y && \
            yum install -y tar gzip which unzip zip && \
            curl -s 'https://get.sdkman.io' | bash && \
            source ~/.sdkman/bin/sdkman-init.sh && \
            sdk install java {{.GRAALVM_VERSION}} && \
            sdk install maven && \
            export JAVA_HOME=~/.sdkman/candidates/java/current && \
            export PATH=\$JAVA_HOME/bin:\$PATH && \
            ./scripts/build.sh
          "

  # ğŸ—ï¸ Build JARs only (for testing)
  jar:
    desc: ğŸ“¦ Build JAR packages only
    cmds:
      - mvn clean package -DskipTests -q

  # ğŸ§ª Test
  test:
    desc: ğŸ§ª Run all tests
    cmds:
      - mvn test

  test:unit:
    desc: ğŸ§ª Run unit tests only
    cmds:
      - mvn test -Dtest=*Test

  test:integration:
    desc: ğŸ§ª Run integration tests only
    cmds:
      - mvn test -Dtest=*IntegrationTest

  # ğŸ—ï¸ Infrastructure
  tf:init:
    desc: ğŸ—ï¸ Initialize Terraform
    dir: terraform
    cmds:
      - terraform init

  tf:plan:
    desc: ğŸ“‹ Plan Terraform changes
    dir: terraform
    deps: [tf:init]
    cmds:
      - terraform plan

  tf:apply:
    desc: ğŸš€ Apply Terraform changes
    dir: terraform
    deps: [native]
    cmds:
      - terraform apply -auto-approve

  tf:destroy:
    desc: ğŸ’¥ Destroy infrastructure
    dir: terraform
    cmds:
      - terraform destroy -auto-approve

  tf:validate:
    desc: âœ… Validate Terraform
    dir: terraform
    deps: [tf:init]
    cmds:
      - terraform validate
      - terraform fmt -check

  # ğŸ§ª Infrastructure Testing
  terratest:
    desc: ğŸ§ª Run Terratest infrastructure tests
    dir: infra-tests
    deps: [tf:apply]
    cmds:
      - go mod tidy
      - go test -v -timeout 15m -run TestLambdaIntegration

  # ğŸš€ Full Deployment
  deploy:
    desc: ğŸš€ Full deployment (native + infrastructure)
    cmds:
      - task: native
      - task: tf:apply

  deploy:dev:
    desc: ğŸš€ Deploy to development
    env:
      TF_VAR_environment: dev
    cmds:
      - task: deploy

  # ğŸ“Š Monitoring
  logs:
    desc: ğŸ“Š View Lambda logs
    cmds:
      - aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/{{.PROJECT_NAME}}" --query 'logGroups[*].logGroupName'

  # ğŸ§¹ Complete cleanup
  nuke:
    desc: ğŸ’¥ Complete cleanup (destroy + clean)
    cmds:
      - task: tf:destroy
      - task: clean
      - docker system prune -f

  # ğŸƒ Development workflow
  dev:
    desc: ğŸƒ Development workflow (test + native + deploy)
    cmds:
      - task: test
      - task: deploy:dev