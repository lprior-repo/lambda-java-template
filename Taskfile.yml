version: '3'

# Serverless Acceleration Platform - Java Template
# Velocity First: Ship with Confidence & Discipline

vars:
  PROJECT_NAME: lambda-java-template
  AWS_REGION: us-east-1
  ENVIRONMENT: dev
  JAVA_VERSION: 17
  MAVEN_OPTS: -Xmx2g

env:
  AWS_REGION: "{{.AWS_REGION}}"
  MAVEN_OPTS: "{{.MAVEN_OPTS}}"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list-all

  # ğŸš€ Velocity First: Build & Package
  deps:
    desc: Download Maven dependencies
    cmds:
      - mvn dependency:resolve dependency:resolve-sources
    sources:
      - pom.xml

  compile:
    desc: Compile Java sources
    deps: [deps]
    cmds:
      - mvn compile
    sources:
      - src/main/**/*.java
      - pom.xml
    generates:
      - target/classes/**

  build:
    desc: Build and package Java Lambda functions
    deps: [compile]
    cmds:
      - mvn package -DskipTests
    sources:
      - src/main/**/*.java
      - pom.xml
    generates:
      - target/*.jar

  package:
    desc: Package Lambda functions for deployment
    deps: [build]
    cmds:
      - mkdir -p build
      - cp target/hello-lambda.jar build/
      - cp target/users-lambda.jar build/
      - echo "âœ… Lambda JARs ready: build/hello-lambda.jar, build/users-lambda.jar"
    sources:
      - target/*.jar
    generates:
      - build/*.jar

  # ğŸ§ª Test-First: Build with Quality
  test:
    desc: Run all tests with coverage
    deps: [compile]
    cmds:
      - mvn test jacoco:report
      - echo "ğŸ“Š Coverage report: target/site/jacoco/index.html"

  test:unit:
    desc: Run unit tests only
    deps: [compile]
    cmds:
      - mvn test -Dtest="**/*Test"

  test:integration:
    desc: Run integration tests
    deps: [compile]
    cmds:
      - mvn test -Dtest="**/*IT"

  test:watch:
    desc: Run tests in watch mode for TDD
    deps: [compile]
    cmds:
      - |
        if command -v watchexec >/dev/null 2>&1; then
          watchexec -e java,xml -- mvn test-compile test
        else
          echo "âš ï¸  Install watchexec for watch mode: brew install watchexec"
          echo "ğŸ“‹ Run 'mvn test' manually after changes"
        fi

  test:coverage:
    desc: Generate detailed test coverage report
    deps: [test]
    cmds:
      - mvn jacoco:report
      - echo "ğŸ“Š Coverage report: target/site/jacoco/index.html"
      - |
        if command -v open >/dev/null 2>&1; then
          open target/site/jacoco/index.html
        fi

  # ğŸ“Š Observability First: Ship with Insight
  logs:
    desc: Tail Lambda function logs
    cmds:
      - aws logs tail /aws/lambda/{{.PROJECT_NAME}}-hello --follow

  logs:hello:
    desc: Get hello function logs with JSON formatting
    cmds:
      - echo "ğŸ“‹ Latest log streams for hello function:"
      - aws logs describe-log-streams --log-group-name /aws/lambda/{{.PROJECT_NAME}}-hello --order-by LastEventTime --descending --max-items 5
      - echo "ğŸ“ Recent structured log events:"
      - aws logs get-log-events --log-group-name /aws/lambda/{{.PROJECT_NAME}}-hello --log-stream-name $(aws logs describe-log-streams --log-group-name /aws/lambda/{{.PROJECT_NAME}}-hello --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text) --limit 50

  logs:users:
    desc: Get users function logs with JSON formatting
    cmds:
      - echo "ğŸ“‹ Latest log streams for users function:"
      - aws logs describe-log-streams --log-group-name /aws/lambda/{{.PROJECT_NAME}}-users --order-by LastEventTime --descending --max-items 5
      - echo "ğŸ“ Recent structured log events:"
      - aws logs get-log-events --log-group-name /aws/lambda/{{.PROJECT_NAME}}-users --log-stream-name $(aws logs describe-log-streams --log-group-name /aws/lambda/{{.PROJECT_NAME}}-users --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text) --limit 50

  xray:
    desc: View X-Ray traces and service map
    cmds:
      - echo "ğŸ” X-Ray Service Map: https://{{.AWS_REGION}}.console.aws.amazon.com/xray/home?region={{.AWS_REGION}}#/service-map"
      - echo "ğŸ“Š X-Ray Traces: https://{{.AWS_REGION}}.console.aws.amazon.com/xray/home?region={{.AWS_REGION}}#/traces"
      - echo "âš¡ Performance Insights: https://{{.AWS_REGION}}.console.aws.amazon.com/lambda/home?region={{.AWS_REGION}}#/functions"

  metrics:
    desc: View CloudWatch metrics dashboard
    cmds:
      - echo "ğŸ“Š CloudWatch Dashboard: https://{{.AWS_REGION}}.console.aws.amazon.com/cloudwatch/home?region={{.AWS_REGION}}#dashboards:name={{.PROJECT_NAME}}"
      - echo "â˜• JVM Metrics: Memory, GC, Thread usage available in CloudWatch"

  # ğŸ—ï¸ Infrastructure as Code
  tf:init:
    desc: Initialize Terraform
    dir: terraform
    cmds:
      - terraform init

  tf:plan:
    desc: Plan Terraform changes
    dir: terraform
    deps: [tf:init]
    cmds:
      - terraform plan -var="environment={{.ENVIRONMENT}}"

  tf:apply:
    desc: Apply Terraform changes
    dir: terraform
    deps: [package]
    cmds:
      - terraform apply -var="environment={{.ENVIRONMENT}}" -auto-approve

  tf:destroy:
    desc: Destroy Terraform infrastructure
    dir: terraform
    cmds:
      - terraform destroy -var="environment={{.ENVIRONMENT}}" -auto-approve

  # ğŸ” OIDC Bootstrap
  bootstrap:
    desc: Bootstrap OIDC for GitHub Actions deployment
    dir: terraform
    deps: [tf:init]
    cmds:
      - |
        echo "ğŸš€ Bootstrapping OIDC infrastructure..."
        read -p "GitHub Organization: " GITHUB_ORG
        read -p "GitHub Repository: " GITHUB_REPO
        read -p "Create new OIDC provider? (y/n): " CREATE_OIDC
        CREATE_OIDC_BOOL=$([ "$CREATE_OIDC" = "y" ] && echo "true" || echo "false")
        terraform plan \
          -var="github_org=$GITHUB_ORG" \
          -var="github_repo=$GITHUB_REPO" \
          -var="create_oidc_provider=$CREATE_OIDC_BOOL" \
          -var="environment={{.ENVIRONMENT}}" \
          -out=bootstrap.tfplan
        echo ""
        echo "ğŸ“‹ Review the plan above. Continue? (y/n)"
        read -p "> " CONTINUE
        if [ "$CONTINUE" = "y" ]; then
          terraform apply bootstrap.tfplan
          echo ""
          echo "âœ… OIDC infrastructure created!"
          echo "ğŸ”§ Bootstrap script generated at: scripts/bootstrap-oidc.sh"
          echo "ğŸ“„ Run the script to generate GitHub Actions workflow"
        else
          echo "âŒ Bootstrap cancelled"
        fi

  tf:validate:
    desc: Validate Terraform configuration
    dir: terraform
    cmds:
      - terraform validate
      - terraform fmt -check

  tf:security:
    desc: Run security checks on Terraform
    dir: terraform
    cmds:
      - |
        if command -v tfsec >/dev/null 2>&1; then
          tfsec .
        else
          echo "âš ï¸  tfsec not installed. Install with: brew install tfsec"
        fi

  # ğŸ›¡ï¸ Well-Architected: Ship with Excellence
  lint:
    desc: Run Java code quality checks
    deps: [compile]
    cmds:
      - mvn checkstyle:check
      - mvn spotbugs:check
      - mvn pmd:check

  lint:fix:
    desc: Auto-fix code formatting issues
    cmds:
      - mvn spotless:apply

  security:
    desc: Run security audit and vulnerability scanning
    deps: [compile]
    cmds:
      - mvn dependency-check:check
      - |
        if mvn help:describe -Dplugin=com.github.spotbugs:spotbugs-maven-plugin >/dev/null 2>&1; then
          mvn spotbugs:spotbugs
        fi

  analyze:
    desc: Run static code analysis
    deps: [compile]
    cmds:
      - mvn sonar:sonar -Dsonar.host.url=http://localhost:9000 || echo "âš ï¸  SonarQube not available"
      - mvn site

  validate:
    desc: Run all validation checks
    deps: [compile]
    cmds:
      - task: lint
      - task: test
      - task: security
      - task: tf:validate
      - task: tf:security

  validate:prod-ready:
    desc: Comprehensive production readiness validation
    cmds:
      - echo "ğŸ” Starting production readiness validation..."
      - task: validate
      - task: test:coverage
      - task: validate:powertools
      - task: validate:monitoring
      - task: validate:native
      - echo "âœ… Production readiness validation completed!"

  validate:powertools:
    desc: Validate AWS Lambda Powertools integration
    cmds:
      - echo "ğŸ”§ Validating Lambda Powertools integration..."
      - grep -r "@Logging" product-service/src/ || echo "âŒ Missing @Logging annotations"
      - grep -r "@Tracing" product-service/src/ || echo "âŒ Missing @Tracing annotations" 
      - grep -r "TracingUtils" product-service/src/ || echo "âŒ Missing TracingUtils usage"
      - grep -r "MDC" product-service/src/ || echo "âŒ Missing structured logging"
      - echo "âœ… Lambda Powertools validation completed"

  validate:monitoring:
    desc: Validate CloudWatch monitoring setup
    cmds:
      - echo "ğŸ“Š Validating CloudWatch monitoring setup..."
      - test -f terraform/cloudwatch.tf || echo "âŒ Missing CloudWatch configuration"
      - grep -q "aws_cloudwatch_dashboard" terraform/cloudwatch.tf || echo "âŒ Missing CloudWatch dashboards"
      - grep -q "aws_cloudwatch_metric_alarm" terraform/cloudwatch.tf || echo "âŒ Missing CloudWatch alarms"
      - grep -q "aws_sns_topic" terraform/cloudwatch.tf || echo "âŒ Missing SNS alerts"
      - echo "âœ… CloudWatch monitoring validation completed"

  validate:native:
    desc: Validate GraalVM native build capabilities
    cmds:
      - echo "ğŸ—ï¸ Validating GraalVM native build setup..."
      - test -f build-graalvm-native.sh || echo "âŒ Missing native build script"
      - grep -q "native-maven-plugin" pom.xml || echo "âŒ Missing native Maven plugin"
      - grep -q "graalvm" .github/workflows/ci.yml || echo "âŒ Missing GraalVM in CI pipeline"
      - echo "âœ… GraalVM native build validation completed"

  # ğŸš€ Deployment Pipeline
  deploy:dev:
    desc: Deploy to development environment
    cmds:
      - task: validate
      - task: tf:apply
        vars: {ENVIRONMENT: dev}

  deploy:staging:
    desc: Deploy to staging environment
    cmds:
      - task: validate
      - task: tf:apply
        vars: {ENVIRONMENT: staging}

  deploy:prod:
    desc: Deploy to production environment
    cmds:
      - task: validate
      - task: tf:apply
        vars: {ENVIRONMENT: prod}

  # ğŸ§¹ Cleanup
  clean:
    desc: Clean build artifacts
    cmds:
      - mvn clean
      - rm -rf build/

  clean:tf:
    desc: Clean Terraform state (DANGEROUS)
    dir: terraform
    cmds:
      - rm -rf .terraform/
      - rm -f .terraform.lock.hcl
      - rm -f terraform.tfstate*

  # ğŸ” Development Tools
  dev:setup:
    desc: Setup Java development environment
    cmds:
      - java --version
      - mvn --version
      - task: deps
      - task: tf:init
      - echo "âœ… Java development environment ready!"
      - echo "â˜• Java version: {{.JAVA_VERSION}}"
      - echo "ğŸ—ï¸  Maven configured with {{.MAVEN_OPTS}}"
      - echo "ğŸ’¡ Run 'task test:watch' for TDD workflow"
      - echo "ğŸš€ Run 'task deploy:dev' to deploy"

  dev:tools:
    desc: Install Java development tools
    cmds:
      - |
        echo "ğŸ› ï¸ Java development tools available:"
        echo "â€¢ SpotBugs: Static analysis for bugs"
        echo "â€¢ Checkstyle: Code style checking"
        echo "â€¢ PMD: Source code analyzer"
        echo "â€¢ JaCoCo: Code coverage"
        echo "â€¢ OWASP Dependency Check: Security vulnerabilities"

  dev:invoke:
    desc: Invoke Lambda function locally using SAM
    deps: [package]
    cmds:
      - |
        echo "ğŸ§ª Invoking hello function locally..."
        if command -v sam >/dev/null 2>&1; then
          sam local invoke HelloFunction --event events/api-gateway-event.json
        else
          echo "âš ï¸  AWS SAM CLI not installed"
        fi

  dev:debug:
    desc: Start Lambda function in debug mode
    deps: [package]
    cmds:
      - |
        echo "ğŸ› Starting debug mode on port 5858..."
        if command -v sam >/dev/null 2>&1; then
          sam local start-api --debug-port 5858
        else
          echo "âš ï¸  AWS SAM CLI not installed"
        fi

  api:docs:
    desc: Generate API documentation from OpenAPI spec
    cmds:
      - |
        if command -v redoc-cli >/dev/null 2>&1; then
          redoc-cli build openapi.yaml --output docs/api.html
          echo "ğŸ“š API documentation generated: docs/api.html"
        else
          echo "âš ï¸  redoc-cli not installed. Run: npm install -g redoc-cli"
        fi

  api:validate:
    desc: Validate OpenAPI specification
    cmds:
      - |
        if command -v swagger-codegen >/dev/null 2>&1; then
          swagger-codegen validate -i openapi.yaml
        else
          echo "âš ï¸  swagger-codegen not installed"
          echo "ğŸ“ OpenAPI spec located at: openapi.yaml"
        fi

  # ğŸ“Š Performance Analysis
  profile:
    desc: Run JVM profiling
    deps: [package]
    cmds:
      - echo "ğŸ”¬ JVM profiling available through:"
      - echo "â€¢ CloudWatch JVM metrics (automatic)"
      - echo "â€¢ X-Ray performance traces"
      - echo "â€¢ JFR (Java Flight Recorder) for detailed analysis"

  benchmark:
    desc: Run performance benchmarks
    deps: [compile]
    cmds:
      - mvn test -Dtest="**/*Benchmark"

  # ğŸ“Š Well-Architected Review
  review:
    desc: Open Well-Architected review document
    cmds:
      - |
        if [ -f "WELL_ARCHITECTED.md" ]; then
          echo "ğŸ“‹ Opening Well-Architected review..."
          open WELL_ARCHITECTED.md 2>/dev/null || echo "ğŸ“„ Review document: WELL_ARCHITECTED.md"
        else
          echo "âŒ WELL_ARCHITECTED.md not found. Run 'task generate:docs' first."
        fi

  generate:docs:
    desc: Generate project documentation
    cmds:
      - task: api:docs
      - task: test:coverage
      - mvn site
      - echo "ğŸ“š Documentation generated successfully!"
      - echo "ğŸ“Š Coverage report: target/site/jacoco/index.html"
      - echo "ğŸ“š API docs: docs/api.html"
      - echo "ğŸ—ï¸  Maven site: target/site/index.html"

  # ğŸ”§ Advanced Java Tools
  graalvm:setup:
    desc: Setup GraalVM for native compilation
    cmds:
      - |
        echo "ğŸš€ GraalVM Native Image setup:"
        echo "1. Install GraalVM: sdk install java 17.0.8-graal"
        echo "2. Install native-image: gu install native-image"
        echo "3. Run: task graalvm:compile"

  graalvm:compile:
    desc: Compile to native image with GraalVM
    deps: [package]
    cmds:
      - |
        if command -v native-image >/dev/null 2>&1; then
          echo "ğŸ”¨ Compiling to native image..."
          native-image -jar build/hello-lambda.jar build/hello-native
          echo "âœ… Native image: build/hello-native"
        else
          echo "âš ï¸  GraalVM native-image not available"
        fi